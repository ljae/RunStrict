# RunStrict Development Specification: "The 280-Day Journey"

> **Last Updated**: 2026-01-24  
> **App Name**: RunStrict (Project Code: 280-Journey)  
> **Current Season Status**: D-280 (Pre-season)

---

## Table of Contents

1. [Project Overview](#1-project-overview)
2. [Rule Definitions](#2-rule-definitions)
   - 2.1 Season & Time System
   - 2.2 Teams & Factions
   - 2.3 Crew System
   - 2.4 Hex Capture Mechanics
   - 2.5 Economy & Points
   - 2.6 Ranking & Leaderboard
   - 2.7 Purple Crew: Protocol of Chaos
   - 2.8 D-Day Reset Protocol
3. [UI Structure](#3-ui-structure)
   - 3.1 Navigation Architecture
   - 3.2 Screen Specifications
   - 3.3 Widget Library
   - 3.4 Theme & Visual Language
4. [Data Structure](#4-data-structure)
   - 4.1 Client Models
   - 4.2 Database Schema (PostgreSQL)
   - 4.3 Data Lifecycle & Partitioning Strategy
   - 4.4 Hot vs Cold Data Strategy
   - 4.5 Local Storage (SQLite)
5. [Tech Stack & Architecture](#5-tech-stack--architecture)
   - 5.1 Backend Platform Decision
   - 5.2 Package Dependencies
   - 5.3 Directory Structure
   - 5.4 GPS Anti-Spoofing
6. [Development Roadmap](#6-development-roadmap)
7. [Success Metrics](#7-success-metrics)
8. [Appendix](#8-appendix)

---

## 1. Project Overview

### Concept

A location-based running game that gamifies territory control through hexagonal maps.

- **Season**: Fixed **280 days** (Gestation period metaphor).
- **Reset**: On D-Day (D-0), all territories and scores are deleted (The Void). Only personal history remains.

### Core Philosophy

| Surface Layer | Hidden Layer |
|---------------|--------------|
| Red vs Blue competition | Connection through rivalry |
| Territory capture | Mutual respect growth |
| Weekly battles | Long-term relationships |
| "Win at all costs" | "We ran together" |

### Key Differentiators

- **Natural unity discovery** through competition phases
- **Purple Crew**: Mid-season chaos mechanic â€” larger crew capacity for higher multiplier potential
- **Simultaneous Runner Multiply**: Crew benefit scales linearly with active runners
- **Privacy-first hex system**: No timestamps or runner IDs stored

---

## 2. Rule Definitions

### 2.1 Season & Time System

| Property | Value |
|----------|-------|
| Season Duration | 280 days (D-280 â†’ D-0) |
| Server Timezone | GMT+2 (Israel Standard Time) |
| Season Start | Immediately after previous season ends |
| Purple Unlock Day | D-140 (midpoint) |

**Rules:**
- The server operates on an absolute countdown. All users share the same timeline.
- Remaining days vary by entry point (e.g., joining at D-260 vs D-5).
- On D-0, all Flip Points, Crew data, and Rankings are wiped.
- Personal running history (Calendar/DailyStats) persists across seasons.
- No daily settlement cycle â€” points are calculated in real-time.

### 2.2 Teams & Factions

| Team | Code | Display Name | Emoji | Color | Base Multiplier |
|------|------|-------------|-------|-------|-----------------|
| Red | `red` | FLAME | ğŸ”¥ | `#FF003C` | 1x |
| Blue | `blue` | WAVE | ğŸŒŠ | `#008DFF` | 1x |
| Purple | `purple` | CHAOS | ğŸ’œ | `#8B5CF6` | 1x |

**Rules:**
- On first entry, user MUST choose Red or Blue.
- Team choice is locked for the entire season.
- **Exception**: User can defect to Purple after D-140 (see Â§2.7).
- Purple is NOT available at season start.
- All teams have the same base multiplier (1x). Advantage comes from crew size (see Â§2.5).

### 2.3 Crew System

#### 2.3.1 Red/Blue Crews

| Property | Value |
|----------|-------|
| Max Members | 12 |
| Formation Rule | Same-color members only |
| Membership | One person, one crew |
| Entry Security | Optional 4-digit PIN (stored plaintext for MVP) |
| Max Simultaneous Multiplier | 12x |

**Rules:**
- Any Red/Blue user can create a crew.
- `memberIds[0]` is the crew leader (creator).
- Users can voluntarily withdraw at any time. No cooldown.
- If the leader leaves, leadership auto-transfers to the next oldest member (`memberIds[1]`).
- If a crew reaches 0 members, it is automatically deleted.
- Crew representative image is auto-generated by the app on creation.
- When a user joins a crew, their avatar is forcibly changed to the crew's representative image.

#### 2.3.2 Purple Crews

| Property | Value |
|----------|-------|
| Max Members | 24 |
| Formation Rule | Any user who has defected to Purple |
| Unlock Condition | Season reaches D-140 |
| Entry Cost | All existing Flip Points reset to 0 |
| Max Simultaneous Multiplier | 24x |

**Rules:**
- Only users who defect from Red/Blue can join Purple.
- Defection permanently changes team for the remainder of the season.
- User MUST leave their current crew before defecting to Purple.
- Any Purple user can create a new Purple crew.
- Purple's advantage is crew capacity (24 members = up to 24x multiplier vs Red/Blue's 12x max).

### 2.4 Hex Capture Mechanics

#### 2.4.1 Hex Grid Configuration

| Property | Value |
|----------|-------|
| H3 Resolution | 8 |
| Avg Hex Edge Length | ~461m |
| Avg Hex Area | ~0.74 kmÂ² |
| Target Coverage | Neighborhood level (~500m radius) |

#### 2.4.2 Capture Rules

| Rule | Value |
|------|-------|
| Pace Threshold | < 8:00 min/km (must be running, not walking) |
| Speed Cap | < 25 km/h (anti-spoofing) |
| GPS Accuracy | Must be â‰¤ 50m to be valid |
| Trigger | GPS coordinate enters hex boundary (immediate) |
| Color Logic | Hex displays color of LAST runner only |
| Stored Data | `lastRunnerTeam` only (no timestamp, no runner ID) |

**Rules:**
- A hex changes color when a valid runner's GPS enters the hex boundary.
- "Valid runner" = pace < 8:00 min/km AND speed < 25 km/h AND GPS accuracy â‰¤ 50m.
- Purple runners paint hexes purple (regardless of original team before defection).
- No ownership mechanic â€” only "who ran here last".
- Accelerometer validation is required even in MVP (anti-spoofing).

#### 2.4.3 Flip Definition

A **Flip** occurs when a hex changes color (any color change counts).

| Transition | Is Flip? | Points? |
|------------|----------|---------|
| Neutral â†’ Red | âœ… Yes | +1 Flip Point |
| Neutral â†’ Blue | âœ… Yes | +1 Flip Point |
| Red â†’ Blue | âœ… Yes | +1 Flip Point |
| Blue â†’ Red | âœ… Yes | +1 Flip Point |
| Red â†’ Purple | âœ… Yes | +1 Flip Point |
| Blue â†’ Purple | âœ… Yes | +1 Flip Point |
| Red â†’ Red (same team) | âŒ No | 0 |

**Daily Flip Limit per Hex:**
- A runner can only earn flip points from the **same hex once per day**.
- Example: Runner A (Red) flips Hex #123 to Red â†’ gets point. Later, Runner B (Blue) flips it back. Runner A re-flips it to Red â†’ **no point** (already flipped this hex today).
- The limit resets at midnight (server time, GMT+2).

**No streak bonus.** No daily flip cap (unlimited unique hexes per day).

### 2.5 Economy & Points

#### 2.5.1 Flip Points

| Property | Value |
|----------|-------|
| Earning Method | Flipping a hex (any color change) |
| Base Points Per Flip | 1 |
| Multiplier | Simultaneous crew runners (see Â§2.5.2) |
| Scope | Individual (not shared with crew) |
| Reset | Wiped on D-0 (season end) |
| Daily Hex Limit | Same hex: once per day per runner |

**Rules:**
- All Flip Points belong to the individual, not the crew.
- Points are calculated in real-time (no daily settlement).
- No streak bonuses. No daily total cap.

#### 2.5.2 Simultaneous Runner Multiply (Crew Benefit)

The core crew benefit: **multiplier = number of crew members actively running at the same time.**

| Crew Members Running | Multiplier | Example (1 flip) |
|---------------------|------------|-------------------|
| 1 | 1x | 1 point |
| 2 | 2x | 2 points |
| 3 | 3x | 3 points |
| 5 | 5x | 5 points |
| 12 (Red/Blue max) | 12x | 12 points |
| 24 (Purple max) | 24x | 24 points |

**Rules:**
- "Simultaneously running" = active running session at the same time. Location is irrelevant.
- The multiplier applies to ALL crew members who are currently running.
- The multiplier updates in real-time as crew members start/stop runs.
- Example: If 5 crew members are running and one of them flips a hex, they earn 5 points (not 1).

**Purple Advantage:**
- Purple has NO base multiplier bonus (removed).
- Purple's advantage is purely crew capacity: max 24 members = potential 24x vs Red/Blue's max 12x.
- This means Purple crews need to coordinate more runners to maximize their advantage.

#### 2.5.3 Points Calculation Flow

```
[Runner flips a hex]
  â†’ RPC: has_flipped_today(user_id, hex_id)
    â†’ true: No points awarded
    â†’ false:
      â†’ INSERT daily_flips (user_id, date_key, hex_id)
      â†’ RPC: get_crew_multiplier(crew_id) â†’ returns N
      â†’ UPDATE users SET season_points += N
      â†’ UPDATE hexes SET last_runner_team = team
      â†’ Supabase Realtime broadcasts to subscribed clients
```

### 2.6 Ranking & Leaderboard

| Property | Value |
|----------|-------|
| Type | Season cumulative only (no daily/weekly) |
| Ranking Metric | Individual accumulated Flip Points |
| Crew Affiliation Impact | None (purely individual) |
| Update | Real-time |
| Display | Top rankings per geographic scope |

**Geographic Scope Filters:**

| Scope | Definition | Display |
|-------|-----------|---------|
| ALL | Entire server | Top N users globally |
| City | `[â“ DEFINE: Based on visible hex count on map â€” proposal needed]` | Top N in city |
| Zone | `[â“ DEFINE: Smaller subdivision â€” proposal needed]` | Top N in zone |

> **Note**: City/Zone boundaries are determined by the number of hexagons visible on the MapScreen at different zoom levels. Technical proposal for mapping zoom levels to geographic scopes is needed during implementation.

**Rules:**
- Leaderboard shows top users per selected scope.
- Users outside top ranks see their own rank in a sticky footer.
- Purple users have a distinct glowing border in the [ALL] view.
- Team filter tabs: [ALL] / [RED] / [BLUE] / [PURPLE].

### 2.7 Purple Crew: Protocol of Chaos

#### 2.7.1 Unlock & Entry

| Property | Value |
|----------|-------|
| Unlock Day | D-140 (season midpoint) |
| Entry Name | "Traitor's Gate" |
| Entry Cost | All existing Flip Points reset to **0** |
| Eligibility | Any Red/Blue user (anytime after D-140) |
| Pre-condition | Must leave current crew first |

**Rules:**
- Purple is designed as a "comeback mechanic" for underperforming players.
- Larger crew capacity (24 vs 12) compensates for the late start and point reset.
- Once defected, cannot return to Red/Blue for the remainder of the season.
- No minimum Flip Point threshold to defect (anyone can defect).
- Defection is available at any time after D-140 until season end.

#### 2.7.2 Purple Mechanics

| Property | Value |
|----------|-------|
| Base Multiplier | 1x (same as Red/Blue) |
| Max Crew Size | 24 members |
| Max Simultaneous Multiplier | 24x |
| Hex Color | Purple (distinct from Red/Blue) |
| Role | "Virus/Joker" â€” disrupts Red/Blue territory with larger coordinated crews |

### 2.8 D-Day Reset Protocol (The Void)

| Step | Action | Method |
|------|--------|--------|
| 1 | Season countdown reaches D-0 | Scheduled Edge Function |
| 2 | Archive season runs to cold storage | Export â†’ Supabase Storage |
| 3 | All hex colors reset to neutral | `TRUNCATE TABLE hexes` (instant) |
| 4 | All Crew data deleted | `TRUNCATE TABLE crews CASCADE` (instant) |
| 5 | All Flip Points & team wiped | `UPDATE users SET season_points=0, crew_id=NULL, team=NULL` |
| 6 | Drop season's run partitions | `DROP TABLE runs_p20XX_XX` (instant disk reclaim) |
| 7 | Personal history preserved | `daily_stats` partitions untouched |
| 8 | Next season begins immediately (D-280) | New season record created |
| 9 | All users must re-select Red or Blue | `team = NULL` forces re-selection |

**Data Preservation:**
- âœ… Kept: Personal run history (`daily_stats`), Hex path archives (Cold Storage)
- âŒ Wiped: Flip Points, Crew membership, Rankings, Hex colors, Team selection
- âš¡ Deletion Method: `TRUNCATE`/`DROP PARTITION` = **$0 cost, < 1 second**, no performance impact

---

## 3. UI Structure

### 3.1 Navigation Architecture

```
App Entry
â”œâ”€â”€ Team Selection Screen (first-time / new season)
â””â”€â”€ Home Screen (Navigation Hub)
    â”œâ”€â”€ AppBar
    â”‚   â”œâ”€â”€ [Left] Empty
    â”‚   â”œâ”€â”€ [Center] FlipPoints Widget (animated counter, team-colored glow)
    â”‚   â””â”€â”€ [Right] Season Countdown Badge (D-day)
    â”œâ”€â”€ Bottom Tab Bar + Swipe Navigation
    â”‚   â”œâ”€â”€ Tab: Map Screen
    â”‚   â”œâ”€â”€ Tab: Running Screen
    â”‚   â”œâ”€â”€ Tab: Leaderboard Screen
    â”‚   â”œâ”€â”€ Tab: Run History Screen (Calendar)
    â”‚   â””â”€â”€ Tab: Crew Screen
    â””â”€â”€ Profile Screen (accessible from settings/menu)
        â””â”€â”€ Manifesto (12-char, editable anytime)
```

**Navigation:** Bottom tab bar with horizontal swipe between tabs. Tab order follows current implementation.

### 3.2 Screen Specifications

#### 3.2.1 Team Selection Screen

| Element | Spec |
|---------|------|
| Purpose | Onboarding (first time) + new season re-selection |
| UI | Animated team cards with gradient text |
| Interaction | Tap to select Red or Blue |
| Lock | Cannot be revisited until next season |
| Purple | Not shown here (accessed via Traitor's Gate after D-140) |

#### 3.2.2 Home Screen

| Element | Spec |
|---------|------|
| AppBar Left | Empty |
| AppBar Center | FlipPoints Widget |
| AppBar Right | Season Countdown Badge |
| Body | Selected tab content |
| Navigation | Bottom tabs + horizontal swipe |

**FlipPoints Widget Behavior:**
- Animated flip counter showing current season points
- On each flip: team-colored glow + scale bounce animation (current implementation)
- Designed for peripheral vision awareness during runs

#### 3.2.3 Map Screen (The Void)

| Element | Spec |
|---------|------|
| Default State | Grey/transparent hexes |
| Colored Hexes | Painted by running activity |
| User Location | Person icon inside a hexagon (team-colored) |
| Hex Interaction | None (view only) |
| Camera | Smooth pan to user location |

**Hex Visual States:**

| State | Fill Color | Opacity | Border | Animation |
|-------|-----------|---------|--------|-----------|
| Neutral | `#2A3550` | 0.15 | Gray `#6B7280`, 1px | None |
| Blue | Blue light | 0.3 | Blue, 1.5px | None |
| Red | Red light | 0.3 | Red, 1.5px | None |
| Purple | Purple light | 0.3 | Purple, 1.5px | None |
| Capturable | Different team color | 0.3 | Team color, 1.5px | **Pulsing** (see below) |
| Current (runner here) | Team color | 0.5 | Team color, 2.5px | None |

**Capturable Hex Pulsing Effect:**
Hexes that meet ALL conditions pulse to indicate "flip opportunity":
1. Color is different from the user's team, AND
2. User has NOT flipped this hex today

| Parameter | Value |
|-----------|-------|
| Period | 2 seconds |
| Scale | 1.0x â†’ 1.2x â†’ 1.0x |
| Glow | Appears and fades together with scale |
| Curve | Ease-in-out |

#### 3.2.4 Running Screen

**Pre-Run State:**

| Element | Spec |
|---------|------|
| Map | Visible with hex grid overlay |
| Status Indicator | "READY" text |
| Start Button | Pulsing hold-to-start (Energy Hold Button, 1.5s) |
| Top Bar | Team indicator |
| Capturable Hexes | Pulsing effect visible |

**Active Run State:**

| Element | Spec |
|---------|------|
| User Marker | Glowing ball (team-colored, pulsing) |
| Camera Mode | Navigation mode â€” map rotates based on direction |
| Camera FPS | 60fps smooth interpolation (SmoothCameraController) |
| Route Trail | Tracing line draws running path |
| Stats Overlay | Distance, Time, Pace |
| Top Bar | "RUNNING" + team-colored pulsing dot |
| Stop Button | Hold-to-stop (1.5s hold, no confirmation dialog) |
| Hex Capture | 300ms fade transition when hex color changes |
| Active Crew Runners | Show count (for multiplier awareness) |

**Important:** FlipPoints are shown in AppBar header ONLY (not duplicated in running screen).

#### 3.2.5 Leaderboard Screen

| Element | Spec |
|---------|------|
| Team Tabs | [ALL] / [RED] / [BLUE] / [PURPLE] |
| Scope Tabs | [ALL] / [City] / [Zone] |
| List | Top rankings for selected scope |
| Sticky Footer | "My Rank" (if user outside top displayed) |
| Purple Users | Glowing border in [ALL] tab |
| Per User | Avatar, Name, Flip Points |

#### 3.2.6 Run History Screen (Calendar)

Current implementation maintained. Key elements:
- Month view calendar grid
- Dot indicators per day with activity
- Stats: Total km, Avg Pace, Total Time

#### 3.2.7 Crew Screen

| Element | Spec |
|---------|------|
| Create Crew | Name + optional 4-digit PIN |
| Join Crew | Search/browse + PIN entry |
| Member Display | Avatar grid layout |
| Per Member | Avatar + individual running history & rank |
| Active Status | Running icon (on/off) next to avatar |
| Crew Stats | Total flips, total distance, active runners count |
| Crew Image | Auto-generated on creation |
| Chat | Not included |

#### 3.2.8 Profile Screen

| Element | Spec |
|---------|------|
| Access | Via settings/menu (not a main tab) |
| Manifesto | 12-character declaration, editable anytime |
| Avatar | Personal emoji (overridden by crew image when in crew) |
| Team | Display only (cannot change) |
| Season Stats | Total flips, distance, runs |

### 3.3 Widget Library

| Widget | Purpose | Location |
|--------|---------|----------|
| `FlipPointsWidget` | Animated flip counter | AppBar |
| `SeasonCountdownWidget` | D-day countdown badge | AppBar |
| `EnergyHoldButton` | Hold-to-trigger button (1.5s) | Running Screen |
| `GlowingLocationMarker` | Team-colored pulsing marker | Map/Running |
| `SmoothCameraController` | 60fps camera interpolation | Running Screen |
| `HexagonMap` | Hex grid overlay | Map Screen |
| `RouteMap` | Route display + nav mode | Running Screen |
| `StatCard` | Statistics card | Various |
| `NeonStatCard` | Neon-styled stat card | Various |

### 3.4 Theme & Visual Language

#### Colors

| Token | Hex Code | Usage |
|-------|----------|-------|
| `athleticRed` | `#FF003C` | Red team (FLAME) |
| `electricBlue` | `#008DFF` | Blue team (WAVE) |
| `purple` | `#8B5CF6` | Purple team (CHAOS) |
| `backgroundStart` | `#0F172A` | Dark background |
| `surfaceColor` | `#1E293B` | Card/surface |
| `textPrimary` | `#FFFFFF` | Primary text |
| `textSecondary` | `#94A3B8` | Secondary text |

#### Typography

| Usage | Font | Weight | Notes |
|-------|------|--------|-------|
| Headers | Bebas Neue | Bold | English display text |
| Body | Bebas Neue | Regular | General English text |
| Stats/Numbers | (Current RunningScreen km font) | Medium | Monospace-style for data |
| Korean | Paperlogyfont | Regular | From freesentation.blog |

> **Korean Font Source**: https://freesentation.blog/paperlogyfont

#### Animation Standards

| Animation | Duration | Curve | Notes |
|-----------|----------|-------|-------|
| Flip point increment | Current implementation | Current implementation | Keep as-is |
| Hex color transition | 300ms | Fade | When runner captures hex |
| Capturable hex pulse | 2s period | Ease-in-out | Scale 1.0xâ†’1.2x + glow |
| Camera interpolation | Per-frame (60fps) | Linear interpolation | SmoothCameraController |
| Hold button progress | 1.5s | Linear | Start/Stop buttons |

---

## 4. Data Structure

### 4.1 Client Models

#### Team Enum

```dart
enum Team {
  red,    // Display: "FLAME" ğŸ”¥
  blue,   // Display: "WAVE" ğŸŒŠ
  purple; // Display: "CHAOS" ğŸ’œ

  // No multiplier on Team â€” multiplier comes from simultaneous runners
  String get displayName => switch (this) {
    red => 'FLAME',
    blue => 'WAVE',
    purple => 'CHAOS',
  };
}
```

#### UserModel

```dart
class UserModel {
  final String id;
  final String name;           // Display name
  final Team team;             // Current team (purple = defected)
  final String avatar;         // Emoji avatar (overridden by crew image when in crew)
  final String? crewId;        // Current crew membership
  final int seasonPoints;      // Flip points this season (reset to 0 on Purple defection)
  final String? manifesto;     // 12-char declaration, editable anytime
}
```

**Derived (not stored):**
- `totalDistance` â†’ calculated from `dailyStats/` collection
- `currentSeasonDistance` â†’ calculated from `dailyStats/` within season dates

#### HexModel

```dart
class HexModel {
  final String id;             // H3 hex index (resolution 9)
  final LatLng center;         // Geographic center
  Team? lastRunnerTeam;        // null = neutral, else team color

  // NO timestamps, NO runner IDs (privacy + cost optimization)

  /// Returns true if color actually changed (= a flip occurred)
  bool setRunnerColor(Team runnerTeam) {
    if (lastRunnerTeam == runnerTeam) return false;
    lastRunnerTeam = runnerTeam;
    return true;
  }
}
```

#### CrewModel

```dart
class CrewModel {
  final String id;
  final String name;
  final Team team;              // Red, Blue, or Purple
  final List<String> memberIds; // memberIds[0] = leader
  final String? pin;            // Optional 4-digit PIN (plaintext for MVP)
  final String? representativeImage; // Auto-generated on creation

  // Derived getters
  bool get isPurple => team == Team.purple;
  int get maxMembers => isPurple ? 24 : 12;
  String get leaderId => memberIds.isNotEmpty ? memberIds[0] : '';
}
```

#### RunSession (Active Run â€” Hot Data)

```dart
class RunSession {
  final String id;
  final DateTime startTime;
  DateTime? endTime;
  double distanceMeters;
  List<LocationPoint> route;    // Full GPS path (active tracking)
  int hexesColored;             // Flip count during this run
  Team teamAtRun;               // Team at time of run
  List<String> hexesPassed;     // H3 hex IDs passed through

  double get distanceKm => distanceMeters / 1000;
  Duration get duration => (endTime ?? DateTime.now()).difference(startTime);
  double get paceMinPerKm => /* calculation */;
  bool get canCaptureHex => paceMinPerKm < 8.0;
}
```

#### RunSummary (Completed Run â€” Warm Data)

```dart
class RunSummary {
  final String id;
  final DateTime date;
  final double distanceKm;
  final int durationSeconds;
  final double avgPaceMinPerKm; // min/km (e.g., 6.0 = 6:00 min/km)
  final int hexesColored;       // Flip count
  final Team teamAtRun;
  final List<String> hexPath;   // H3 hex IDs passed (for route shape replay)
}
```

> **Note**: `hexPath` stores the sequence of H3 hex IDs the runner passed through. This provides an approximate route shape without storing raw GPS data in warm storage.

#### DailyRunningStat (Aggregated â€” Warm Data)

```dart
class DailyRunningStat {
  final String userId;
  final String dateKey;             // "2026-01-24" format
  final double totalDistanceKm;
  final int totalDurationSeconds;
  final double avgPaceMinPerKm;     // min/km (e.g., 6.0 = 6:00)
  final int flipCount;              // Total flips that day
}
```

#### DailyHexFlipRecord (Flip Dedup â€” Hot Data)

```dart
/// Tracks which hexes a user has already flipped today (for daily limit)
class DailyHexFlipRecord {
  final String userId;
  final String dateKey;             // "2026-01-24" format
  final Set<String> flippedHexIds;  // H3 hex IDs already flipped today
}
```

#### LocationPoint (Active GPS â€” Ephemeral)

```dart
class LocationPoint {
  final double latitude;
  final double longitude;
  final double altitude;
  final double speed;               // m/s
  final double accuracy;            // meters (must be â‰¤ 50m)
  final DateTime timestamp;
}
```

#### RoutePoint (Cold Storage â€” Compact)

```dart
class RoutePoint {
  final double lat;
  final double lng;
  // Minimal data for route replay (Douglas-Peucker compressed)
}
```

### 4.2 Database Schema (PostgreSQL via Supabase)

#### Core Tables

```sql
-- Users table (permanent, survives season reset)
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  auth_id UUID REFERENCES auth.users(id) NOT NULL,
  name TEXT NOT NULL,
  team TEXT CHECK (team IN ('red', 'blue', 'purple')),
  avatar TEXT NOT NULL DEFAULT 'ğŸƒ',
  crew_id UUID REFERENCES crews(id) ON DELETE SET NULL,
  season_points INTEGER NOT NULL DEFAULT 0,
  manifesto TEXT CHECK (char_length(manifesto) <= 12),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Crews table (deleted on season reset)
CREATE TABLE crews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  team TEXT NOT NULL CHECK (team IN ('red', 'blue', 'purple')),
  member_ids UUID[] NOT NULL DEFAULT '{}',  -- [0] = leader
  pin TEXT,                                  -- Plaintext for MVP
  representative_image TEXT,                 -- Auto-generated
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  
  CONSTRAINT max_members CHECK (
    CASE WHEN team = 'purple' THEN array_length(member_ids, 1) <= 24
         ELSE array_length(member_ids, 1) <= 12
    END
  )
);

-- Hex map (deleted on season reset)
CREATE TABLE hexes (
  id TEXT PRIMARY KEY,                       -- H3 index string (resolution 9)
  last_runner_team TEXT CHECK (last_runner_team IN ('red', 'blue', 'purple'))
  -- NO timestamps, NO runner IDs (privacy + cost)
);

-- Active runs (ephemeral, exists only while running)
CREATE TABLE active_runs (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  crew_id UUID REFERENCES crews(id),
  start_time TIMESTAMPTZ NOT NULL DEFAULT now(),
  team TEXT NOT NULL CHECK (team IN ('red', 'blue', 'purple'))
);
```

#### Season-Partitioned Tables (pg_partman)

```sql
-- Runs table: partitioned by season (280-day periods)
CREATE TABLE runs (
  id UUID NOT NULL DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  team_at_run TEXT NOT NULL CHECK (team_at_run IN ('red', 'blue', 'purple')),
  start_time TIMESTAMPTZ NOT NULL,
  end_time TIMESTAMPTZ,
  distance_meters DOUBLE PRECISION NOT NULL DEFAULT 0,
  avg_pace_min_per_km DOUBLE PRECISION,      -- min/km (e.g., 6.0)
  hexes_colored INTEGER NOT NULL DEFAULT 0,
  hex_path TEXT[] NOT NULL DEFAULT '{}',      -- H3 hex IDs passed
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- Daily stats: partitioned by month
CREATE TABLE daily_stats (
  id UUID NOT NULL DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  date_key DATE NOT NULL,
  total_distance_km DOUBLE PRECISION NOT NULL DEFAULT 0,
  total_duration_seconds INTEGER NOT NULL DEFAULT 0,
  avg_pace_min_per_km DOUBLE PRECISION,
  flip_count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (id, created_at),
  UNIQUE (user_id, date_key, created_at)
) PARTITION BY RANGE (created_at);

-- Daily flip dedup: partitioned by day (auto-dropped after 2 days)
CREATE TABLE daily_flips (
  user_id UUID NOT NULL REFERENCES users(id),
  date_key DATE NOT NULL,
  hex_id TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (user_id, date_key, hex_id, created_at)
) PARTITION BY RANGE (created_at);
```

#### Partition Management (pg_partman)

```sql
-- Auto-create partitions for runs (monthly)
SELECT partman.create_parent(
  p_parent_table := 'public.runs',
  p_control := 'created_at',
  p_type := 'native',
  p_interval := '1 month',
  p_premake := 3
);

-- Auto-create partitions for daily_stats (monthly)
SELECT partman.create_parent(
  p_parent_table := 'public.daily_stats',
  p_control := 'created_at',
  p_type := 'native',
  p_interval := '1 month',
  p_premake := 3
);

-- Auto-create partitions for daily_flips (daily, retain 2 days)
SELECT partman.create_parent(
  p_parent_table := 'public.daily_flips',
  p_control := 'created_at',
  p_type := 'native',
  p_interval := '1 day',
  p_premake := 2,
  p_retention := '2 days'         -- Auto-drop old partitions
);
```

#### Row Level Security (RLS)

```sql
-- Users can only read/update their own profile
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
CREATE POLICY users_self ON users
  USING (auth_id = auth.uid())
  WITH CHECK (auth_id = auth.uid());

-- Hexes are readable by all, writable by authenticated runners
ALTER TABLE hexes ENABLE ROW LEVEL SECURITY;
CREATE POLICY hexes_read ON hexes FOR SELECT USING (true);
CREATE POLICY hexes_write ON hexes FOR UPDATE USING (auth.role() = 'authenticated');

-- Active runs: read all (for multiplier), write own
ALTER TABLE active_runs ENABLE ROW LEVEL SECURITY;
CREATE POLICY active_runs_read ON active_runs FOR SELECT USING (true);
CREATE POLICY active_runs_write ON active_runs
  USING (user_id = (SELECT id FROM users WHERE auth_id = auth.uid()));
```

#### Key Indexes

```sql
CREATE INDEX idx_users_team ON users(team);
CREATE INDEX idx_users_season_points ON users(season_points DESC);
CREATE INDEX idx_users_crew_id ON users(crew_id);
CREATE INDEX idx_active_runs_crew_id ON active_runs(crew_id);
CREATE INDEX idx_daily_stats_user_date ON daily_stats(user_id, date_key);
CREATE INDEX idx_hexes_team ON hexes(last_runner_team);
```

#### Useful Views & Functions

```sql
-- Real-time crew multiplier (count active runners per crew)
CREATE OR REPLACE FUNCTION get_crew_multiplier(p_crew_id UUID)
RETURNS INTEGER AS $$
  SELECT COUNT(*)::INTEGER FROM active_runs WHERE crew_id = p_crew_id;
$$ LANGUAGE sql STABLE;

-- Leaderboard query (efficient with index on season_points)
CREATE OR REPLACE FUNCTION get_leaderboard(p_limit INTEGER DEFAULT 20)
RETURNS TABLE(user_id UUID, name TEXT, team TEXT, season_points INTEGER, rank BIGINT) AS $$
  SELECT id, name, team, season_points,
         ROW_NUMBER() OVER (ORDER BY season_points DESC) as rank
  FROM users
  WHERE season_points > 0
  ORDER BY season_points DESC
  LIMIT p_limit;
$$ LANGUAGE sql STABLE;

-- Check if hex was already flipped today by this user
CREATE OR REPLACE FUNCTION has_flipped_today(p_user_id UUID, p_hex_id TEXT)
RETURNS BOOLEAN AS $$
  SELECT EXISTS(
    SELECT 1 FROM daily_flips
    WHERE user_id = p_user_id
      AND date_key = CURRENT_DATE
      AND hex_id = p_hex_id
  );
$$ LANGUAGE sql STABLE;
```

**Design Principles:**
- `hexes`: Only stores `last_runner_team`. No timestamps or runner IDs â†’ privacy + cost.
- `users`: Distance stats calculated via `daily_stats` aggregation on-demand.
- `runs`: Raw GPS route moved to Cold Storage (S3). `hex_path` stays for shape replay.
- `crews`: `max_members` enforced via CHECK constraint. Leader = `member_ids[0]`.
- `daily_flips`: Partitioned daily with 2-day retention â†’ auto-cleanup, no manual deletion.
- `active_runs`: Ephemeral presence table for simultaneous multiplier calculation.
- All security handled via RLS â€” **no separate backend API server needed**.

### 4.3 Data Lifecycle & Partitioning Strategy

#### Why Partitioning Matters

The 280-day season cycle means massive data accumulates and must be efficiently deleted. Traditional row-by-row DELETE is expensive and causes:
- Index fragmentation
- VACUUM overhead
- Performance degradation during reset

**Solution**: PostgreSQL table partitioning via `pg_partman`.

#### Partition Strategy by Table

| Table | Partition Interval | Retention | D-Day Reset Method |
|-------|-------------------|-----------|-------------------|
| `runs` | Monthly | Season data archived â†’ Cold | `DROP PARTITION` (instant) |
| `daily_stats` | Monthly | **Permanent** (personal history) | Never deleted |
| `daily_flips` | Daily | 2 days | Auto-dropped by pg_partman |
| `hexes` | Not partitioned | Season only | `TRUNCATE TABLE` (instant) |
| `crews` | Not partitioned | Season only | `TRUNCATE TABLE` (instant) |
| `active_runs` | Not partitioned | Ephemeral | `TRUNCATE TABLE` (instant) |

#### D-Day Reset Execution (The Void)

```sql
-- Season reset: executes in < 1 second regardless of data volume
BEGIN;
  -- 1. Archive season runs to cold storage (pre-scheduled batch job)
  -- (runs from current season partitions â†’ S3 export â†’ DROP)
  
  -- 2. Instant wipes (TRUNCATE = instant, no row-by-row cost)
  TRUNCATE TABLE hexes;
  TRUNCATE TABLE crews CASCADE;
  TRUNCATE TABLE active_runs;
  
  -- 3. Reset user season data (UPDATE, not DELETE)
  UPDATE users SET
    season_points = 0,
    crew_id = NULL,
    team = NULL;  -- Forces re-selection
  
  -- 4. Drop season's run partitions (instant, frees disk immediately)
  -- pg_partman handles this via retention policy, or manual:
  -- DROP TABLE runs_p2026_01, runs_p2026_02, ... ;
  
  -- 5. daily_stats are PRESERVED (personal history across seasons)
COMMIT;
```

**Key Advantage over Firebase/Firestore:**
- Firebase charges per-document for deletion (100ä¸‡ docs = 100ä¸‡ write ops = ~$0.18+)
- Supabase/PostgreSQL: `TRUNCATE`/`DROP PARTITION` = **$0, instant, no performance impact**

#### Data Flow Summary

```
[During Season - Hot Path]
  Runner GPS â†’ Client validates â†’ Supabase active_runs (presence)
  Hex flip â†’ daily_flips check â†’ hexes UPDATE â†’ points UPDATE
  All via Supabase Realtime (WebSocket) for live multiplier updates

[Run Completion - Warm Path]
  RunSession â†’ runs table (partitioned)
  Aggregated â†’ daily_stats (partitioned, permanent)
  GPS route â†’ Compressed â†’ S3 (cold)

[D-Day - Reset Path]
  TRUNCATE hexes, crews, active_runs (instant)
  UPDATE users (reset points/team)
  DROP old run partitions (instant disk reclaim)
  daily_stats PRESERVED (personal history)
```

### 4.4 Hot vs Cold Data Strategy

| Tier | Data | Storage | Retention | Reset Behavior |
|------|------|---------|-----------|----------------|
| **Hot** | Hex map, Active runs, Daily flips | Supabase (PostgreSQL) | Current season / day | TRUNCATE / DROP PARTITION |
| **Warm** | DailyStats, RunSummaries (hexPath) | Supabase (PostgreSQL) | **Permanent** | Never deleted |
| **Cold** | Raw GPS paths (LocationPoints) | Supabase Storage (S3-compatible) | **Permanent** | Never deleted |

**Real-time Points Calculation Flow:**

```
[Runner flips a hex]
  â†’ RPC: has_flipped_today(user_id, hex_id)
    â†’ true? â†’ No points (already flipped today)
    â†’ false? â†’
      â†’ INSERT INTO daily_flips (user_id, date_key, hex_id)
      â†’ RPC: get_crew_multiplier(crew_id) â†’ returns N
      â†’ UPDATE users SET season_points = season_points + N
      â†’ UPDATE hexes SET last_runner_team = runner_team
      â†’ Supabase Realtime broadcasts change to subscribed clients
```

**Supabase Realtime Integration:**
- `active_runs` table changes â†’ broadcast to crew members (multiplier updates)
- `hexes` table changes â†’ broadcast to map viewers (color transitions)
- `users.season_points` changes â†’ broadcast to leaderboard

### 4.5 Local Storage (SQLite)

| Table | Purpose | Sync Strategy |
|-------|---------|---------------|
| `runs` | Offline run data | Upload to Supabase on connectivity |
| `routes` | GPS points during active run | Compress â†’ Supabase Storage on completion |
| `daily_stats` | Local cache of daily stats | Pull from Supabase |
| `hex_cache` | Nearby hex data for offline | Cache visible + surrounding hexes |
| `daily_flips` | Local cache of today's flipped hexes | Sync with Supabase |

---

## 5. Tech Stack & Architecture

### 5.1 Backend Platform Decision

#### Why Supabase over Firebase

| Criterion | Firebase (Firestore) | Supabase (PostgreSQL) | Winner |
|-----------|---------------------|----------------------|--------|
| **Data Model** | NoSQL (Document) | Relational (SQL) | Supabase â€” crew/user/season relationships require JOINs |
| **Query Complexity** | Limited (no JOINs, no aggregation) | Full SQL (JOIN, GROUP BY, SUM, Window functions) | Supabase â€” leaderboard & multiplier calculations |
| **Cost Model** | Per-read/write operation | Instance-based (flat rate) | Supabase â€” no per-operation billing explosion at scale |
| **Mass Deletion (D-Day)** | Per-document write cost ($0.18/1M deletes) | TRUNCATE/DROP = $0, instant | Supabase â€” critical for 280-day reset |
| **Real-time** | Firestore listeners | Supabase Realtime (WebSocket) | Tie |
| **Security** | Firebase Rules (custom DSL) | Row Level Security (SQL policies) | Supabase â€” standard SQL, no custom language |
| **Backend API** | Requires Cloud Functions for complex logic | RLS + Edge Functions (optional) | Supabase â€” no separate API server needed |
| **Vendor Lock-in** | Google-proprietary | Open-source (PostgreSQL) | Supabase â€” can self-host if needed |
| **Scaling** | Auto-scales (but cost scales too) | Predictable instance pricing | Supabase â€” budget-friendly at scale |

**Decision**: **Supabase (PostgreSQL)** as primary backend.

#### Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Flutter Client                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Provider  â”‚  â”‚ SQLite   â”‚  â”‚ Supabase Client   â”‚  â”‚
â”‚  â”‚ (State)   â”‚  â”‚ (Offline)â”‚  â”‚ (Auth+DB+Realtime)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Supabase Platform    â”‚
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
              â”‚  â”‚  PostgreSQL DB   â”‚  â”‚
              â”‚  â”‚  (pg_partman)    â”‚  â”‚
              â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
              â”‚  â”‚  Supabase Auth   â”‚  â”‚
              â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
              â”‚  â”‚  Realtime        â”‚  â”‚
              â”‚  â”‚  (WebSocket)     â”‚  â”‚
              â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
              â”‚  â”‚  Storage (S3)    â”‚  â”‚
              â”‚  â”‚  (Cold: GPS)     â”‚  â”‚
              â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
              â”‚  â”‚  Edge Functions  â”‚  â”‚
              â”‚  â”‚  (D-Day reset)   â”‚  â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Serverless Properties:**
- No backend API server to maintain
- RLS handles all authorization at DB level
- Edge Functions only for scheduled tasks (D-Day reset, partition management)
- Supabase Realtime for live multiplier & hex color updates
- Supabase Storage for cold GPS data (replaces AWS S3)

### 5.2 Package Dependencies

```yaml
# Core
flutter: sdk
provider: ^6.1.2

# Location & Maps
geolocator: ^13.0.2
mapbox_maps_flutter: ^2.3.0
latlong2: ^0.9.0
h3_flutter: ^0.7.1

# Supabase (Auth + Database + Realtime + Storage)
supabase_flutter: ^2.0.0

# Local Storage
sqflite: ^2.3.3+2
path_provider: ^2.1.4

# Sensors (Anti-spoofing)
sensors_plus: ^latest          # Accelerometer validation

# UI
google_fonts: ^6.2.1
animated_text_kit: ^4.2.2
shimmer: ^3.0.0
```

> **Migration Note**: `firebase_core`, `cloud_firestore`, and `firebase_auth` are replaced by single `supabase_flutter` package which provides auth, database, realtime, and storage in one SDK.

### 5.3 Directory Structure

```
lib/
â”œâ”€â”€ main.dart                    # App entry point, Provider setup
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ mapbox_config.dart       # Mapbox API configuration
â”‚   â””â”€â”€ supabase_config.dart     # Supabase URL & anon key
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ team.dart                # Team enum (red/blue/purple)
â”‚   â”œâ”€â”€ user_model.dart          # User data model
â”‚   â”œâ”€â”€ hex_model.dart           # Hex tile (lastRunnerTeam only)
â”‚   â”œâ”€â”€ crew_model.dart          # Crew with maxMembers/leaderId
â”‚   â”œâ”€â”€ run_session.dart         # Active run session data
â”‚   â”œâ”€â”€ run_summary.dart         # Completed run (with hexPath)
â”‚   â”œâ”€â”€ daily_running_stat.dart  # Daily stats (Warm data)
â”‚   â”œâ”€â”€ daily_hex_flip_record.dart # Daily flip dedup tracking
â”‚   â”œâ”€â”€ location_point.dart      # GPS point (active run)
â”‚   â””â”€â”€ route_point.dart         # Compact route point (Cold storage)
â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ app_state_provider.dart  # Global app state (team, user)
â”‚   â”œâ”€â”€ run_provider.dart        # Run lifecycle & hex capture
â”‚   â”œâ”€â”€ crew_provider.dart       # Crew management state
â”‚   â””â”€â”€ hex_data_provider.dart   # Hex data cache & state
â”œâ”€â”€ screens/
â”‚   â”œâ”€â”€ team_selection_screen.dart
â”‚   â”œâ”€â”€ home_screen.dart         # Main navigation hub + AppBar
â”‚   â”œâ”€â”€ map_screen.dart          # Hex map exploration view
â”‚   â”œâ”€â”€ running_screen.dart      # Pre-run & active run (unified)
â”‚   â”œâ”€â”€ crew_screen.dart         # Crew management
â”‚   â”œâ”€â”€ leaderboard_screen.dart  # Rankings (ALL/City/Zone scope)
â”‚   â”œâ”€â”€ run_history_screen.dart  # Past runs (Calendar)
â”‚   â””â”€â”€ profile_screen.dart      # Manifesto, avatar, stats
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ supabase_service.dart    # Supabase client init & RPC wrappers
â”‚   â”œâ”€â”€ hex_service.dart         # H3 hex grid operations
â”‚   â”œâ”€â”€ location_service.dart    # GPS tracking
â”‚   â”œâ”€â”€ run_tracker.dart         # Run session & hex capture engine
â”‚   â”œâ”€â”€ gps_validator.dart       # Anti-spoofing (GPS + accelerometer)
â”‚   â”œâ”€â”€ storage_service.dart     # Storage interface (abstract)
â”‚   â”œâ”€â”€ in_memory_storage_service.dart  # In-memory (MVP/testing)
â”‚   â”œâ”€â”€ local_storage_service.dart      # SharedPreferences helpers
â”‚   â”œâ”€â”€ points_service.dart      # Flip points & multiplier calculation
â”‚   â”œâ”€â”€ season_service.dart      # 280-day season countdown
â”‚   â”œâ”€â”€ crew_multiplier_service.dart    # Simultaneous runner tracking (Realtime)
â”‚   â”œâ”€â”€ running_score_service.dart      # Pace validation for capture
â”‚   â””â”€â”€ data_manager.dart        # Hot/Cold data separation
â”œâ”€â”€ storage/
â”‚   â””â”€â”€ local_storage.dart       # SQLite implementation
â”œâ”€â”€ theme/
â”‚   â”œâ”€â”€ app_theme.dart           # Main theme (colors, typography)
â”‚   â””â”€â”€ neon_theme.dart          # Neon accent colors
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ image_utils.dart         # Location marker generation
â”‚   â”œâ”€â”€ route_optimizer.dart     # Ring buffer + Douglas-Peucker
â”‚   â””â”€â”€ lru_cache.dart           # LRU cache for hex data
â””â”€â”€ widgets/
    â”œâ”€â”€ hexagon_map.dart         # Hex grid overlay
    â”œâ”€â”€ route_map.dart           # Running route display + navigation mode
    â”œâ”€â”€ smooth_camera_controller.dart  # 60fps camera interpolation
    â”œâ”€â”€ glowing_location_marker.dart   # Team-colored pulsing marker
    â”œâ”€â”€ flip_points_widget.dart  # Animated flip counter (header)
    â”œâ”€â”€ season_countdown_widget.dart   # D-day countdown badge
    â”œâ”€â”€ energy_hold_button.dart  # Hold-to-trigger button
    â”œâ”€â”€ capturable_hex_pulse.dart     # Pulsing effect for capturable hexes
    â”œâ”€â”€ stat_card.dart           # Statistics card
    â””â”€â”€ neon_stat_card.dart      # Neon-styled stat card
```

### 5.4 GPS Anti-Spoofing

| Validation | Threshold | Action |
|------------|-----------|--------|
| Max Speed | 25 km/h | Discard GPS point |
| Min GPS Accuracy | â‰¤ 50m | Discard GPS point |
| Accelerometer Correlation | Required in MVP | Flag session if no motion detected |
| Pace Threshold | < 8:00 min/km | Required to capture hexes |

---

## 6. Development Roadmap

### Phase 1: Core Gameplay (1â€“3 months)

| Feature | Status | Notes |
|---------|--------|-------|
| GPS distance tracking | âœ… | geolocator package |
| Offline storage (SQLite) | âœ… | |
| Auth (Supabase Auth) | âœ… | Email/Google/Apple |
| Team selection UI | âœ… | team_selection_screen.dart |
| H3 hex grid overlay | âœ… | hex_service.dart |
| Territory visualization | âœ… | hexagon_map.dart |
| Hex state transitions | âœ… | |
| Running screen (unified) | âœ… | Pre-run + Active |
| Navigation mode (bearing) | âœ… | SmoothCameraController |
| Flip point tracking | âœ… | points_service.dart |
| Accelerometer validation | â¬œ | sensors_plus package |
| Speed filter (25 km/h) | â¬œ | In gps_validator.dart |
| GPS accuracy filter (50m) | â¬œ | In gps_validator.dart |
| Daily hex flip dedup | â¬œ | dailyFlips/ collection |
| Capturable hex pulsing | â¬œ | New widget |
| Hex color fade transition | â¬œ | 300ms fade |
| Crew creation | âœ… | crew_model.dart |
| Crew join (backend) | â¬œ | UI exists |
| Crew auto-image generation | â¬œ | On creation |
| Profile screen (manifesto) | â¬œ | |
| Crew stats page | â¬œ | |

### Phase 1.5: Backend Migration (Month 2â€“3)

| Feature | Status | Notes |
|---------|--------|-------|
| Supabase project setup | â¬œ | Auth + DB + Realtime + Storage |
| PostgreSQL schema creation | â¬œ | Tables, indexes, constraints |
| pg_partman partition setup | â¬œ | runs (monthly), daily_flips (daily) |
| RLS policies | â¬œ | No backend API needed |
| Supabase Realtime channels | â¬œ | active_runs, hexes, leaderboard |
| Edge Function: D-Day reset | â¬œ | Scheduled TRUNCATE/DROP |
| Firebase â†’ Supabase migration | â¬œ | Replace all Firebase dependencies |
| supabase_service.dart | â¬œ | Client init & RPC wrappers |

### Phase 2: Social & Economy (4â€“6 months)

| Feature | Status | Notes |
|---------|--------|-------|
| Simultaneous runner multiply | â¬œ | crew_multiplier_service.dart + Realtime |
| Active runner tracking | â¬œ | active_runs table + Supabase Realtime |
| Real-time points calculation | â¬œ | RPC: has_flipped_today + get_crew_multiplier |
| Leaderboard (ALL scope) | â¬œ | SQL function: get_leaderboard() |
| Leaderboard (City/Zone scope) | â¬œ | Based on visible hex count |
| Crew member active status | â¬œ | Running icon on/off via Realtime |
| Hex path in RunSummary | â¬œ | hex_path column in runs table |
| SQLite hex cache | â¬œ | Offline support |

### Phase 3: Purple & Season (7â€“9 months)

| Feature | Status | Notes |
|---------|--------|-------|
| D-140 Purple unlock | â¬œ | Traitor's Gate |
| Point reset on defection | â¬œ | seasonPoints = 0 |
| Purple crew (24 max) | â¬œ | Larger capacity = higher potential multiplier |
| Must-leave-crew gate | â¬œ | Pre-condition for defection |
| 280-day season cycle | â¬œ | |
| D-Day reset protocol | â¬œ | Edge Function: TRUNCATE/DROP (instant) |
| Cold storage archive | â¬œ | Supabase Storage (S3-compatible) |
| New season re-selection | â¬œ | Team re-pick after D-0 |

---

## 7. Success Metrics

### KPIs by Phase

| Category | Metric | Phase 1 | Phase 2 | Phase 3 |
|----------|--------|---------|---------|---------|
| **Users** | DAU | 300 | 1,500 | 5,000 |
| | WAU | 1,000 | 5,000 | 15,000 |
| | MAU | 2,000 | 10,000 | 30,000 |
| **Engagement** | D1 Retention | 50% | 55% | 60% |
| | D7 Retention | 30% | 35% | 40% |
| | D30 Retention | 15% | 20% | 25% |
| | Avg Session | 8 min | 12 min | 15 min |
| **Social** | Crews Formed | 100 | 500 | 2,000 |
| | Avg Crew Size | 4 | 6 | 8 |
| | Avg Simultaneous Runners | 2 | 4 | 6 |
| **Activity** | Runs/Day | 500 | 2,000 | 6,000 |
| | Avg Distance/Run | 3 km | 4 km | 5 km |
| **Purple** | Defection Rate | â€” | â€” | 15% |
| | Purple Crews | â€” | â€” | 50+ |

### Revenue (Post-Launch)

| Metric | Target |
|--------|--------|
| LTV | $15+ |
| CAC | < $5 |
| LTV:CAC | > 3:1 |
| Monthly Churn | < 5% |

---

## 8. Appendix

### A. User Identity Rules

| State | Avatar Display | Leaderboard Name |
|-------|---------------|-----------------|
| Solo (no crew) | Personal avatar | User name |
| In Crew | Crew representative image (forced) | User name |
| Left Crew | Reverts to personal avatar | User name |
| Defected to Purple | Personal avatar (until joining Purple crew) | User name |

### B. Simultaneous Runner Multiply Examples

| Scenario | Crew Members Running | Flip Points per Flip |
|----------|---------------------|---------------------|
| Solo runner (no crew) | 1 | 1 |
| Red crew, 3 running | 3 | 3 |
| Blue crew, 12 running | 12 | 12 |
| Purple crew, 20 running | 20 | 20 |
| Purple crew, 24 running (max) | 24 | 24 |

### C. Leaderboard Geographic Scope

> **Implementation Note**: City/Zone boundaries are determined by the number of hexagons visible on the MapScreen at different zoom levels. The exact mapping of zoom levels to geographic scopes requires a technical proposal during implementation.

Proposed approach (to be refined):
- **ALL**: No geographic filter â€” server-wide ranking
- **City**: H3 resolution 4â€“5 parent cell grouping (or admin boundaries)
- **Zone**: H3 resolution 6â€“7 parent cell grouping (or district boundaries)

### D. Slogans

**Korean:**
- "ê°™ì€ ë•€, ë‹¤ë¥¸ ìƒ‰" (Same sweat, different colors)
- "ìš°ë¦¬ëŠ” ë°˜ëŒ€ë¡œ ë‹¬ë ¤ ë§Œë‚¬ë‹¤" (We ran apart, met together)
- "ë°°ì‹ ì€ ìƒˆë¡œìš´ ì‹œì‘ì´ë‹¤" (Betrayal is a new beginning)

**English:**
- "Run Apart, Meet Together"
- "Same Path, Different Colors"
- "Embrace the Chaos"

### E. Changelog

| Date | Change |
|------|--------|
| 2026-01-24 | Backend migration: Firebase â†’ Supabase (PostgreSQL) for cost/performance optimization |
| 2026-01-24 | Added pg_partman partitioning strategy for D-Day instant reset ($0, <1s) |
| 2026-01-24 | Added RLS policies (no backend API server needed) |
| 2026-01-24 | Added Supabase Realtime for live multiplier & hex updates |
| 2026-01-24 | Cold storage: AWS S3 â†’ Supabase Storage |
| 2026-01-24 | Major restructure: Simultaneous Runner Multiply replaces Top 4/Settlement system |
| 2026-01-24 | Purple 2x base multiplier removed â†’ advantage is crew size (24 max) |
| 2026-01-24 | Results Screen removed |
| 2026-01-24 | Daily hex flip limit added (same hex once per day) |
| 2026-01-24 | Capturable hex pulsing effect defined |
| 2026-01-24 | All [â“ DEFINE] markers resolved |
| 2026-01-23 | FlipPoints moved to header, GPS timeout fix |
| 2026-01-22 | Running screen unified (removed active_run_screen) |
| 2026-01-20 | Data optimization: removed redundant stored fields |
| 2026-01-20 | Purple crew capacity 12â†’24, Twin Crew system removed |

---

## Remaining Open Items

| Item | Status | Notes |
|------|--------|-------|
| Supabase project provisioning | Needs setup | Choose region, plan tier |
| pg_partman extension activation | Needs Supabase support | May require Pro plan or self-hosted |
| Leaderboard City/Zone boundaries | Needs proposal | Based on visible hex count at zoom levels |
| Korean font (Paperlogyfont) integration | Needs package setup | Custom font from freesentation.blog |
| Stats/Numbers font identification | Needs check | Use current RunningScreen km font |
| Accelerometer threshold calibration | Needs testing | MVP must include but threshold TBD via testing |
| Crew auto-image generation algorithm | Needs design | How to auto-generate representative images |
| Supabase Realtime channel design | Needs architecture | Which tables/events to subscribe |
| Edge Function scheduling | Needs setup | D-Day reset trigger mechanism |

---

*This document is the single source of truth for RunStrict game rules, UI structure, and data architecture. All implementations must align with this specification.*
